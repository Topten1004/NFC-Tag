@{
    string roomId = ViewBag.RoomId as string;
}

<div class="row">
    <div class="col-md-4">
        <div class="mb-3" id="roomListContainer">
            <label for="roomList" class="form-label">Room List</label>
            <ul class="list-group" id="roomList">
                <!-- Room list items will be appended here -->
            </ul>
        </div>
    </div>
    <div class="col-md-8">
        <div class="row mb-3">
            <label for="customerName" class="form-label">Customer Name</label>
            <input type="text" class="form-control" id="customerName" placeholder="Enter Customer Name" style="margin:12px;width:80%">
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <div id="chatContainer" class="chat-container"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-9">
                <textarea class="form-control" id="chatMessage" rows="3" placeholder="Type your message..."></textarea>
            </div>
            <div class="col-3">
                <button class="btn btn-primary" id="sendMessageButton">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    let currentRoomId = null;

    connection.start().then(function () {
        console.log("Connected with ID:", connection.connectionId);

        // Automatically join the room if roomId is provided
        const roomId = '@ViewBag.RoomId';

        if (roomId && roomId !== 'null') {
            currentRoomId = roomId;
            connection.invoke("JoinRoom", roomId).catch(function (err) {
                console.log("JoinRoom", roomId);
                console.error("Error joining room:", err.toString());
            });

            // Fetch the room list
            connection.invoke("GetRoomList").catch(function (err) {
                console.log("GetRoomList:::", roomId);
                console.error("Error fetching room list:", err.toString());
            });
        }
    }).catch(function (err) {
        console.error("SignalR connection failed:", err.toString());
    });

    // Handle room list reception
    connection.on("ReceiveRoomList", function (rooms) {
        console.log("ReceiveRoomList:::", rooms);
        $('#roomListContainer').show(); // Show the room list container
        rooms.forEach(room => {
            addRoomToList(room);
        });
    });

    function addRoomToList(room) {
        $('#roomList').append(`<li class="list-group-item">${room}</li>`);
    }

    // Handle room selection
    $('#roomList').on('click', 'li', function () {
        $(this).addClass("active").siblings().removeClass("active");
        currentRoomId = $(this).text();

        // Fetch messages for the selected room
        connection.invoke("GetRoomMessages", currentRoomId).catch(function (err) {
            console.error("Error fetching room messages:", err.toString());
        });
    });

    // Handle room messages reception
    connection.on("ReceiveRoomMessages", function (data) {
        $('#chatContainer').empty(); // Clear previous messages
        data.messages.forEach(message => {
            $('#chatContainer').append(`<div class="message">${message}</div>`);
        });
    });

    // Handle incoming messages
    connection.on("ReceiveMessage", function (data) {
        if (data.roomId === currentRoomId) {
            $('#chatContainer').append(`<div class="message">${data.text}</div>`);
        }
    });

    // Handle sending messages
    $('#sendMessageButton').click(function () {
        const message = $('#chatMessage').val();
        if (message && currentRoomId) {
            connection.invoke("SendMessageToRoom", currentRoomId, message).catch(function (err) {
                console.error("Error sending message:", err.toString());
            });
            $('#chatMessage').val(''); // Clear the message box
        }
    });

    // Reconnect on connection loss
    connection.onclose(function () {
        console.log("SignalR disconnected. Attempting to reconnect...");
        setTimeout(() => connection.start(), 5000); // Retry connection after 5 seconds
    });
</script>
